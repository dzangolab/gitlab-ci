spec:
  inputs:
    build-args:
      default: ''
      type: string 
    dockerfile:
      default: 'Dckerfile'
      type: string 
    image:
      default: ''
      type: string 
---

.buildx:
  teardown:
    - docker buildx rm multiplatform
  setup:
    - docker run --privileged --rm tonistiigi/binfmt --install all
    - docker buildx create --use --driver docker-container --name multiplatform
    - docker buildx inspect multiplatform --bootstrap
  build:
    - DOCKER_BUILDKIT=1 docker buildx build
        $[[ inputs.build-args]]
        --target production
        --platform $DOCKER_PLATFORMS
        --provenance=false
        --push
        -t $[[ inputs.image ]]
        -f $[[ inputs.dockerfile ]] .
    - docker manifest inspect $[[ inputs.image ]]
